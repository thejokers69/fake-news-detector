name: Deploy to Railway

on:
    push:
        branches: ["master"]
    workflow_dispatch: {}

jobs:
    deploy:
        runs-on: ubuntu-latest
        env:
            RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
            RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
            RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Install Railway CLI
              run: |
                  curl -fsSL https://railway.app/install.sh | sh
                  echo "${HOME}/.railway/bin" >> $GITHUB_PATH

            - name: Build image
              run: |
                  docker build -t fake-news-detector:ci .

            - name: Deploy on Railway
              run: |
                  if [ -z "$RAILWAY_TOKEN" ] || [ -z "$RAILWAY_PROJECT_ID" ] || [ -z "$RAILWAY_SERVICE_ID" ]; then
                    echo "Missing Railway secrets: set RAILWAY_TOKEN, RAILWAY_PROJECT_ID, RAILWAY_SERVICE_ID" && exit 1
                  fi
                  railway login --token "$RAILWAY_TOKEN"
                  railway link --project "$RAILWAY_PROJECT_ID" --service "$RAILWAY_SERVICE_ID"
                  railway up --service "$RAILWAY_SERVICE_ID" --detach

            - name: Output deployment hint
              run: |
                  echo "Deployment triggered. Railway assigns a random *.railway.app URL; find it in the Railway dashboard for the linked service."
